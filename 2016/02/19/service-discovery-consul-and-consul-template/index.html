<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Service discovery with consul and consul-template | 东杰书屋</title>
    
    
        <meta name="keywords" content="consul" />
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="I talked in the past about an “Ops Design Pattern: local haproxy talking to service layer”. I described how we used a local haproxy on pretty much all nodes at a given layer of our infrastructure (web">
<meta name="keywords" content="consul">
<meta property="og:type" content="article">
<meta property="og:title" content="Service discovery with consul and consul-template">
<meta property="og:url" content="https://blog.djstudy.net/2016/02/19/service-discovery-consul-and-consul-template/index.html">
<meta property="og:site_name" content="东杰书屋">
<meta property="og:description" content="I talked in the past about an “Ops Design Pattern: local haproxy talking to service layer”. I described how we used a local haproxy on pretty much all nodes at a given layer of our infrastructure (web">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2016-02-19T03:37:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Service discovery with consul and consul-template">
<meta name="twitter:description" content="I talked in the past about an “Ops Design Pattern: local haproxy talking to service layer”. I described how we used a local haproxy on pretty much all nodes at a given layer of our infrastructure (web">
    

    
        <link rel="alternate" href="/atom.xml" title="东杰书屋" type="application/atom+xml" />
    

    
        <link rel="icon" href="/favicon.ico" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    
        <script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?05207dc6d0c785fb39a80bb5af7c3d8a# enter Baidu Analytics hash key";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>

    


    
        <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">东杰书屋</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
                    <a class="main-nav-link" href="/arch">架构</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Buscar" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Entradas',
            PAGES: 'Pages',
            CATEGORIES: 'Categorias',
            TAGS: 'Etiquetas',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                    <td><a class="main-nav-link" href="/arch">架构</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Buscar" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id='categories'>
        <h3 class="widget-title">
            <span>Categorias</span>
            &nbsp;
            <a id='allExpand' href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree" > 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            big data
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2016/07/27/hbase-minor-vs-major-compaction/">hbase 压缩合并中的minor与major区别</a></li>  <li class="file"><a href="/2016/09/28/hbase-rit/">hbase中的RIT的那些事</a></li>  <li class="file"><a href="/2016/02/04/presto-parquet-airpal/">Presto, Parquet & Airpal</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            distribution 
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file active"><a href="/2016/02/19/service-discovery-consul-and-consul-template/">Service discovery with consul and consul-template</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            elasticsearch
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2016/07/27/es-flush-vs-refresh/">elasticsearch中的refresh和flush区别</a></li>  <li class="file"><a href="/2017/04/27/es-shard-interaction/">Elasticsearch 分片交互过程详解</a></li>  <li class="file"><a href="/2016/02/27/how-many-shards-index/">Optimizing Elasticsearch-How Many Shards per Index</a></li>  <li class="file"><a href="/2017/06/06/openresty-kibana-post/">使用openresty获取kibana查询post参数</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            hadoop
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2016/01/24/hdp-spark-shell-error/">ambari hdp中部署apache spark运行spark shell遇到的错误解决</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            scala
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2016/03/19/scala-note-2/">scala学习笔记(二)</a></li>  <li class="file"><a href="/2016/03/16/scala-note-1/">scala学习笔记(一)</a></li>  <li class="file"><a href="/2016/07/10/scala-note-3/">scala学习笔记(三)</a></li>  <li class="file"><a href="/2016/01/24/scala-rumen-biji/">scala入门笔记</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            spark
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2016/01/24/spark-convert-text-parquet/">将 Spark 中的文本转换为 Parquet 以提升性能</a></li>  <li class="file"><a href="/2016/01/24/spark-ha/">Spark Standalone模式HA环境搭建</a></li>  <li class="file"><a href="/2016/01/24/spark-on-yarn/">spark on yarn</a></li>  <li class="file"><a href="/2016/01/27/spark-sort-shuffle-analyse/">Spark Sort Based Shuffle内存分析</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            数据结构与算法
                        </a>
                         <ul class="unstyled" id="tree" >  <li class="file"><a href="/2016/09/21/comb-sort/">comb sort(梳排序)</a></li>  </ul> 
                    </li> 
                     </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-service-discovery-consul-and-consul-template" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/distribution/">distribution </a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/consul/">consul</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/02/19/service-discovery-consul-and-consul-template/">
            <time datetime="2016-02-19T03:27:26.000Z" itemprop="datePublished">2016-02-19</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a href='http://git.djstudy.net//hivefans/blog/raw/master/source/_posts/service-discovery-consul-and-consul-template.md'> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a href='http://git.djstudy.net//hivefans/blog/edit/master/source/_posts/service-discovery-consul-and-consul-template.md'> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a href='http://git.djstudy.net//hivefans/blog/commits/master/source/_posts/service-discovery-consul-and-consul-template.md'> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            Service discovery with consul and consul-template
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <p>I talked in the past about an <a href="http://agiletesting.blogspot.com/2013/12/ops-design-pattern-local-haproxy.html" target="_blank" rel="external">“Ops Design Pattern: local haproxy talking to service layer”</a>. I described how we used a local haproxy on pretty much all nodes at a given layer of our infrastructure (webapp, API, e-commerce) to talk to services offered by the layer below it. So each webapp server has a local haproxy that talks to all API nodes it sends requests to. Similarly, each API node has a local haproxy that talks to all e-commerce nodes it needs info from.</p>
<p>This seemed like a good idea at a time, but it turns out it has a couple of annoying drawbacks:<br>each local haproxy runs health checks against N nodes, so if you have M nodes running haproxy, each of the N nodes will receive M health checks; if M and N are large, then you have a health check storm on your hands<br>to take a node out of a cluster at any given layer, we tag it as ‘inactive’ in Chef, then run chef-client on all nodes that run haproxy and talk to the inactive node at layers above it; this gets old pretty fast, especially when you’re doing anything that might conflict with Chef and that the chef-client run might overwrite (I know, I know, you’re not supposed to do anything of that nature, but we are all human :-)<br>For the second point, we are experimenting with haproxyctl so that we don’t have to run chef-client on every node running haproxy. But it still feels like a heavy-handed approach.</p>
<p>If I were to do this again (which I might), I would still have an haproxy instance in front of our webapp servers, but for communicating from one layer of services to another I would use a proper service discovery tool such as grampa Apache ZooKeeper or the newer kids on the block, etcd from CoreOS and consul from HashiCorp.</p>
<p>I settled on consul for now, so in this post I am going to show how you can use consul in conjunction with the recently released consul-template to discover services and to automate configuration changes. At the same time, I wanted to experiment a bit with Ansible as a configuration management tool. So the steps I’ll describe were actually automated with Ansible, but I’ll leave that for another blog post.</p>
<p>The scenario I am going to describe involves 2 haproxy instances, each pointing to 2 Wordpress servers running Apache, PHP and MySQL, with Varnish fronting the Wordpress application. One of the 2 Wordpress servers is considered primary as far as haproxy is concerned, and the other one is a backup server, which will only get requests if the primary server is down. All servers are running Ubuntu 12.04.</p>
<p>Install and run the consul agent on all nodes</p>
<p>The agent will start in server mode on the 2 haproxy nodes, and in agent mode on the 2 Wordpress nodes.</p>
<p>I first deployed consul to the 2 haproxy nodes. I used a modified version of the ansible-consul role from jivesoftware. The configuration file /etc/consul.cfg for the first server (lb1) is:</p>
<p>{<br>  “domain”: “consul.”,<br>  “data_dir”: “/opt/consul/data”,<br>  “log_level”: “INFO”,<br>  “node_name”: “lb1”,<br>  “server”: true,<br>  “bind_addr”: “10.0.0.1”,<br>  “datacenter”: “us-west-1b”,<br>  “bootstrap”: true,<br>  “rejoin_after_leave”: true<br>}</p>
<p>(and similar for lb2, with only node_name and bind_addr changed to lb2 and 10.0.0.2 respectively)</p>
<p>The ansible-consul role also creates a consul user and group, and an upstart configuration file like this:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/init/consul.conf</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Consul Agent (Upstart unit)</span></div><div class="line">description <span class="string">"Consul Agent"</span></div><div class="line">start on (<span class="built_in">local</span>-filesystems and net-device-up IFACE!=lo)</div><div class="line">stop on runlevel [06]</div><div class="line"></div><div class="line"><span class="built_in">exec</span> sudo -u consul -g consul /opt/consul/bin/consul agent -config-dir /etc/consul.d -config-file=/etc/consul.conf &gt;&gt; /var/<span class="built_in">log</span>/consul 2&gt;&amp;1</div><div class="line">respawn</div><div class="line">respawn <span class="built_in">limit</span> 10 10</div><div class="line"><span class="built_in">kill</span> timeout 10</div><div class="line"></div><div class="line">To start/stop consul, I use:</div><div class="line"></div><div class="line"><span class="comment"># start consul</span></div><div class="line"><span class="comment"># stop consul</span></div></pre></td></tr></table></figure>
<p>Note that “server” is set to true and “bootstrap” is also set to true, which means that each consul server will be the leader of a cluster with 1 member, itself. To join the 2 servers into a consul cluster, I did the following:<br>join lb1 to lb2: on lb1 run consul join 10.0.0.2<br>tail /var/log/consul on lb1, note messages complaining about both consul servers (lb1 and lb2) running in bootstrap mode<br>stop consul on lb1: stop consul<br>edit /etc/consul.conf on lb1 and set  “bootstrap”: false<br>start consul on lb1: start consul<br>tail /var/log/consul on both lb1 and lb2; it should show no more errors<br>run consul info on both lb1 and lb2; the output should show server=true on both nodes, but leader=true only on lb2<br>Next I ran the consul agent in regular non-server mode on the 2 Wordpress nodes. The configuration file /etc/consul.cfg on node wordpress1 was:</p>
<p>{<br>  “domain”: “consul.”,<br>  “data_dir”: “/opt/consul/data”,<br>  “log_level”: “INFO”,<br>  “node_name”: “wordpress1”,<br>  “server”: false,<br>  “bind_addr”: “10.0.1.1”,<br>  “datacenter”: “us-west-1b”,<br>  “rejoin_after_leave”: true<br>}</p>
<p>(and similar for wordpress2, with the node_name set to wordpress2 and bind_addr set to 10.0.1.2)</p>
<p>After starting up the agents via upstart, I joined them to lb2 (although the could be joined to any of the existing members of the cluster). I ran this on both wordpress1 and wordpress2:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># consul join 10.0.0.2</span></div><div class="line"></div><div class="line">At this point, running consul members on any of the 4 nodes should show all 4 members of the cluster:</div><div class="line"></div><div class="line">Node          Address         Status  Type    Build  Protocol</div><div class="line">lb1           10.0.0.1:8301   alive   server  0.4.0  2</div><div class="line">wordpress2    10.0.1.2:8301   alive   client  0.4.0  2</div><div class="line">lb2           10.0.0.2:8301   alive   server  0.4.0  2</div><div class="line">wordpress1    10.0.1.1:8301   alive   client  0.4.0  2</div></pre></td></tr></table></figure></p>
<p>Install and run dnsmasq on all nodes</p>
<p>The ansible-consul role does this for you. Consul piggybacks on DNS resolution for service naming, and by default the domain names internal to Consul start with consul. In my case they are configured in consul.cfg via “domain”: “consul.”</p>
<p>The dnsmasq configuration file for consul is:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/dnsmasq.d/10-consul</span></div><div class="line"></div><div class="line">server=/consul./127.0.0.1<span class="comment">#8600</span></div></pre></td></tr></table></figure></p>
<p>This causes dnsmasq to provide DNS resolution for domain names starting with consul. by querying a DNS server on 127.0.0.1 running on port 8600 (which is the port the local consul agent listens on to provide DNS resolution).</p>
<p>To start/stop dnsmasq, use: service dnsmasq start | stop.</p>
<p>Now that dnsmasq is running, you can look up names that end in .node.consul from any member node of the consul cluster (there are 4 member nodes in my cluster, 2 servers and 2 agents). For example, I ran this on lb2:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ dig wordpress1.node.consul</div><div class="line"></div><div class="line">; &lt;&lt;&gt;&gt; DiG 9.8.1-P1 &lt;&lt;&gt;&gt; wordpress1.node.consul</div><div class="line">;; global options: +cmd</div><div class="line">;; Got answer:</div><div class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 2511</div><div class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</div><div class="line"></div><div class="line">;; QUESTION SECTION:</div><div class="line">;wordpress1.node.consul.  IN A</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">wordpress1.node.consul. 0 IN A 10.0.1.1</div><div class="line"></div><div class="line">;; Query time: 1 msec</div><div class="line">;; SERVER: 127.0.0.1<span class="comment">#53(127.0.0.1)</span></div><div class="line">;; WHEN: Fri Nov 14 00:09:16 2014</div><div class="line">;; MSG SIZE  rcvd: 76</div></pre></td></tr></table></figure></p>
<p>Configure services and checks on consul agent nodes</p>
<p>Internal DNS resolution within the .consul domain becomes even more useful when nodes define services and checks. For example, the 2 Wordpress nodes run varnish and apache (on port 80 and port 443) so we can define 3 services as JSON files in /etc/consul.d. On wordpress1, which is our active/primary node in haproxy, I defined these services:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">$ cat http_service.json</div><div class="line">&#123;</div><div class="line">    <span class="string">"service"</span>: &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"http"</span>,</div><div class="line">        <span class="string">"tags"</span>: [<span class="string">"primary"</span>],</div><div class="line">        <span class="string">"port"</span>:80,</div><div class="line">        <span class="string">"check"</span>: &#123;</div><div class="line">                <span class="string">"id"</span>: <span class="string">"http_check"</span>,</div><div class="line">                <span class="string">"name"</span>: <span class="string">"HTTP Health Check"</span>,</div><div class="line">   <span class="string">"script"</span>: <span class="string">"curl -H 'Host=www.mydomain.com' http://localhost"</span>,</div><div class="line">         <span class="string">"interval"</span>: <span class="string">"5s"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$ cat ssl_service.json</div><div class="line">&#123;</div><div class="line">    <span class="string">"service"</span>: &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"ssl"</span>,</div><div class="line">        <span class="string">"tags"</span>: [<span class="string">"primary"</span>],</div><div class="line">        <span class="string">"port"</span>:443,</div><div class="line">        <span class="string">"check"</span>: &#123;</div><div class="line">                <span class="string">"id"</span>: <span class="string">"ssl_check"</span>,</div><div class="line">                <span class="string">"name"</span>: <span class="string">"SSL Health Check"</span>,</div><div class="line">   <span class="string">"script"</span>: <span class="string">"curl -k -H 'Host=www.mydomain.com' https://localhost:443"</span>,</div><div class="line">         <span class="string">"interval"</span>: <span class="string">"5s"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$ cat varnish_service.json</div><div class="line">&#123;</div><div class="line">    <span class="string">"service"</span>: &#123;</div><div class="line">        <span class="string">"name"</span>: <span class="string">"varnish"</span>,</div><div class="line">        <span class="string">"tags"</span>: [<span class="string">"primary"</span>],</div><div class="line">        <span class="string">"port"</span>:6081 ,</div><div class="line">        <span class="string">"check"</span>: &#123;</div><div class="line">                <span class="string">"id"</span>: <span class="string">"varnish_check"</span>,</div><div class="line">                <span class="string">"name"</span>: <span class="string">"Varnish Health Check"</span>,</div><div class="line">   <span class="string">"script"</span>: <span class="string">"curl http://localhost:6081"</span>,</div><div class="line">         <span class="string">"interval"</span>: <span class="string">"5s"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Each service we defined has a name, a port and a check with its own ID, name, script that runs whenever the check is executed, and an interval that specifies how often the check is run. In the examples above I specified simple curl commands against the ports that these services are running on. Note also that each service has a list of tags associated with it. In my case, the services on wordpress1 have the tag “primary”. The services defined on wordpress2 are identical to the ones on wordpress1 with the only difference being the tag, which on wordpress2 is “backup”.</p>
<p>After restarting consul on wordpress1 and wordpress2, the following service-related DNS names are available for resolution on all nodes in the consul cluster (I am going to include only relevant portions of the dig output):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ dig varnish.service.consul</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">varnish.service.consul. 0 IN A 10.0.1.1</div><div class="line">varnish.service.consul. 0 IN A 10.0.1.2</div></pre></td></tr></table></figure></p>
<p>This name resolves in DNS round-robin fashion to the IP addresses of all nodes that are running the varnish service, regardless of their tags and regardless of the data centers that their nodes run in. In our case, it resolves to the IP addresses of wordpress1 and wordpress2.</p>
<p>Note that the IP address of a given node only appears in the DNS result set if the service running on that node has a healty check. If the check fails, then consul’s DNS service will not include the IP of the node in the result set. This is very important for the dynamic discovery of healthy services.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ dig varnish.service.us-west-1b.consul</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">varnish.service.us-west-1b.consul. 0 IN A 10.0.1.2</div><div class="line">varnish.service.us-west-1b.consul. 0 IN A 10.0.1.1</div></pre></td></tr></table></figure></p>
<p>If we include the data center (in our case us-west-1b) in the DNS name we query, then only the services running on nodes in that data center will be returned in the result set. In our case though, all nodes run in the us-west-1b data center, so this query returns, like the previous one, the IP addresses of wordpress1 and wordpress2. Note that the IPs can be returned in any order, because of DNS round-robin. In this case the IP of wordpress2 was first.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ dig SRV varnish.service.consul</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">varnish.service.consul. 0 IN SRV 1 1 6081 wordpress1.node.us-west-1b.consul.</div><div class="line">varnish.service.consul. 0 IN SRV 1 1 6081 wordpress2.node.us-west-1b.consul.</div><div class="line"></div><div class="line">;; ADDITIONAL SECTION:</div><div class="line">wordpress1.node.us-west-1b.consul. 0 IN A 10.0.1.1</div><div class="line">wordpress2.node.us-west-1b.consul. 0 IN A 10.0.1.2</div></pre></td></tr></table></figure></p>
<p>A useful feature of the consul DNS service is that it returns the port number that a given service runs on when queried for an SRV record. So this query returns the names and IPs of the nodes that the varnish service runs on, as well as the port number, which in this case is 6081. The application querying for the SRV record needs to interpret this extra piece of information, but this is very useful for the discovery of internal services that might run on non-standard port numbers.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ dig primary.varnish.service.consul</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">primary.varnish.service.consul. 0 IN A 10.0.1.1</div><div class="line"></div><div class="line">$ dig backup.varnish.service.consul</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">backup.varnish.service.consul. 0 IN A 10.0.1.2</div></pre></td></tr></table></figure></p>
<p>The 2 DNS queries above show that it’s possible to query a service by its tag, in our case ‘primary’ vs. ‘backup’. The result set will contain the IP addresses of the nodes tagged with the specific tag and running the specific service we asked for. This feature will prove useful when dealing with consul-template in haproxy, as I’ll show later in this post.</p>
<p>Load balance across services</p>
<p>It’s easy now to see how an application can take advantage of the internal DNS service provided by consul and load balance across services. For example, an application that needs to load balance across the 2 varnish services on wordpress1 and wordpress2 would use varnish.service.consul as the DNS name it talks to when it needs to hit varnish. Every time this DNS name is resolved, a random node from wordpress1 and wordpress2 is returned via the DNS round-robin mechanism. If varnish were to run on a non-standard port number, the application would need to issue a DNS request for the SRV record in order to obtain the port number as well as the IP address to hit.</p>
<p>Note that this method of load balancing has health checks built in. If the varnish health check fails on one of the nodes providing the varnish service, that node’s IP address will not be included in the DNS result set returned by the DNS query for that service.</p>
<p>Also note that the DNS query can be customized for the needs of the application, which can query for a specific data center, or a specific tag, as I showed in the examples above.</p>
<p>Force a node out of service</p>
<p>I am still looking for the best way to take nodes in and out of service for maintenance or other purposes. One way I found so far is to deregister a given service via the Consul HTTP API. Here is an example of a curl command that accomplishes that, executed on node wordpress1:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ curl -v http://localhost:8500/v1/agent/service/deregister/varnish</div><div class="line">* About to connect() to localhost port 8500 (<span class="comment">#0)</span></div><div class="line">*   Trying 127.0.0.1... connected</div><div class="line">&gt; GET /v1/agent/service/deregister/varnish HTTP/1.1</div><div class="line">&gt; User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3</div><div class="line">&gt; Host: localhost:8500</div><div class="line">&gt; Accept: */*</div><div class="line">&gt;</div><div class="line">&lt; HTTP/1.1 200 OK</div><div class="line">&lt; Date: Mon, 17 Nov 2014 19:01:06 GMT</div><div class="line">&lt; Content-Length: 0</div><div class="line">&lt; Content-Type: text/plain; charset=utf-8</div><div class="line">&lt;</div><div class="line">* Connection <span class="comment">#0 to host localhost left intact</span></div><div class="line">* Closing connection <span class="comment">#0</span></div></pre></td></tr></table></figure></p>
<p>The effect of this command is that the varnish service on node wordpress1 is ‘deregistered’, which for my purposes means ‘marked as down’. DNS queries for varnish.service.consul will only return the IP address of wordpress2:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ dig varnish.service.consul</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">varnish.service.consul. 0 IN A 10.0.1.2</div></pre></td></tr></table></figure></p>
<p>We can also use the Consul HTTP API to verify that the varnish service does not appear in the list of active services on node wordpress1. We’ll use the /agent/services API call and we’ll save the output to a file called services.out, then we’ll use the jq tool to pretty-print the output:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ curl -v http://localhost:8500/v1/agent/services -o services.out</div><div class="line"></div><div class="line">$ jq . &lt;&lt;&lt; `cat services.out`</div><div class="line">&#123;</div><div class="line">  <span class="string">"http"</span>: &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">"http"</span>,</div><div class="line">    <span class="string">"Service"</span>: <span class="string">"http"</span>,</div><div class="line">    <span class="string">"Tags"</span>: [</div><div class="line">      <span class="string">"primary"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"Port"</span>: 80</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"ssl"</span>: &#123;</div><div class="line">    <span class="string">"ID"</span>: <span class="string">"ssl"</span>,</div><div class="line">    <span class="string">"Service"</span>: <span class="string">"ssl"</span>,</div><div class="line">    <span class="string">"Tags"</span>: [</div><div class="line">      <span class="string">"primary"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"Port"</span>: 443</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Note that only the http and ssl services are shown.</p>
<p>Force a node back in service</p>
<p>Again, I am still looking for the best way to mark as service as ‘up’ once it was marked as ‘down’. One way would be to register the service via the Consul HTTP API, and that requires issuing a POST request with the payload being the JSON configuration file for that service. Another way is to just restart the consul agent on the node in question. This will register the service that had been deregistered previously.</p>
<p>Install and configure consul-template</p>
<p>For the next few steps, I am going to show how to use consul-template in conjuction with consul for discovering services and configuring haproxy based on the discovered services.</p>
<p>I automated the installation and configuration of consul-template via an Ansible role that I put on Github, but I am going to discuss the main steps here. See also the instructions on the consul-template Github page.</p>
<p>In my Ansible role, I copy the consul-template binary to the target node (in my case the 2 haproxy nodes lb1 and lb2), then create a directory structure /opt/consul-template/{bin,config,templates}. The consul-template configuration file is /opt/consul-template/config/consul-template.cfg and it looks like this in my case:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ cat config/consul-template.cfg</div><div class="line">consul = <span class="string">"127.0.0.1:8500"</span></div><div class="line"></div><div class="line">template &#123;</div><div class="line">  <span class="built_in">source</span> = <span class="string">"/opt/consul-template/templates/haproxy.ctmpl"</span></div><div class="line">  destination = <span class="string">"/etc/haproxy/haproxy.cfg"</span></div><div class="line">  <span class="built_in">command</span> = <span class="string">"service haproxy restart"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Note that consul-template needs to be able to talk a consul agent, which in my case is the local agent listening on port 8500. The template that consul-template maintains is defined in another file,  /opt/consul-template/templates/haproxy.ctmpl. What consul-template does is monitor changes to that file via changes to the services referenced in the file. Upon any such change, consul-template will generate a new target file based on the template and copy it to the destination file, which in my case is the haproxy config file /etc/haproxy/haproxy.cfg. Finally, consul-template will executed a command, which in my case is the restarting of the haproxy service.</p>
<p>Here is the actual template file for my haproxy config, which is written in the Go template format:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">$ cat /opt/consul-template/templates/haproxy.ctmpl</div><div class="line"></div><div class="line">global</div><div class="line">  <span class="built_in">log</span> 127.0.0.1   local0</div><div class="line">  maxconn 4096</div><div class="line">  user haproxy</div><div class="line">  group haproxy</div><div class="line"></div><div class="line">defaults</div><div class="line">  <span class="built_in">log</span>     global</div><div class="line">  mode    http</div><div class="line">  option  dontlognull</div><div class="line">  retries 3</div><div class="line">  option redispatch</div><div class="line">  timeout connect 5s</div><div class="line">  timeout client 50s</div><div class="line">  timeout server 50s</div><div class="line">  balance  roundrobin</div><div class="line"></div><div class="line"><span class="comment"># Set up application listeners here.</span></div><div class="line"></div><div class="line">frontend http</div><div class="line">  maxconn &#123;&#123;key <span class="string">"service/haproxy/maxconn"</span>&#125;&#125;</div><div class="line">  <span class="built_in">bind</span> 0.0.0.0:80</div><div class="line">  default_backend servers-http-varnish</div><div class="line"></div><div class="line">backend servers-http-varnish</div><div class="line">  balance            roundrobin</div><div class="line">  option httpchk GET /</div><div class="line">  option  httplog</div><div class="line">&#123;&#123;range service <span class="string">"primary.varnish"</span>&#125;&#125;</div><div class="line">    server &#123;&#123;.Node&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; weight 1 check port &#123;&#123;.Port&#125;&#125;</div><div class="line">&#123;&#123;end&#125;&#125;</div><div class="line">&#123;&#123;range service <span class="string">"backup.varnish"</span>&#125;&#125;</div><div class="line">    server &#123;&#123;.Node&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; backup weight 1 check port &#123;&#123;.Port&#125;&#125;</div><div class="line">&#123;&#123;end&#125;&#125;</div><div class="line"></div><div class="line">frontend https</div><div class="line">  maxconn            &#123;&#123;key <span class="string">"service/haproxy/maxconn"</span>&#125;&#125;</div><div class="line">  mode               tcp</div><div class="line">  <span class="built_in">bind</span>               0.0.0.0:443</div><div class="line">  default_backend    servers-https</div><div class="line"></div><div class="line">backend servers-https</div><div class="line">  mode               tcp</div><div class="line">  option             tcplog</div><div class="line">  balance            roundrobin</div><div class="line">&#123;&#123;range service <span class="string">"primary.ssl"</span>&#125;&#125;</div><div class="line">    server &#123;&#123;.Node&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; weight 1 check port &#123;&#123;.Port&#125;&#125;</div><div class="line">&#123;&#123;end&#125;&#125;</div><div class="line">&#123;&#123;range service <span class="string">"backup.ssl"</span>&#125;&#125;</div><div class="line">    server &#123;&#123;.Node&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; backup weight 1 check port &#123;&#123;.Port&#125;&#125;</div><div class="line">&#123;&#123;end&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>To the trained eye, this looks like a regular haproxy configuration file, with the exception of the portions bolded above. These are Go template snippets which rely on a couple of template functions exposed by consul-template above and beyond what the Go templating language offers. Specifically, the key function queries a key stored in the Consul key/value store and outputs the value associated with that key (or an empty string if the value doesn’t exist). The service function queries a consul service by its DNS name and returns a result set used inside the range statement. The variables inside the result set can be inspected for properties such as Node, Address and Port, which correspond to the Consul service node name, IP address and port number for that particular service.</p>
<p>In my example above, I use the value of the key service/haproxy/maxconn as the value of maxconn. In the http-varnish backend, I used 2 sets of services names, primary.varnish and backup.varnish, because I wanted to differentiate in haproxy.cfg between the primary server (wordpress1 in my case) and the backup server (wordpress2). In the ssl backend, I did the same but with the ssl service.</p>
<p>Everything so far would work fine with the exception of the key/value pair represented by the key service/haproxy/maxconn. To define that pair, I used the Consul key/value store API (this can be run on any member of the Consul cluster):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">$ cat set_haproxy_maxconn.sh</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">MAXCONN=4000</div><div class="line"></div><div class="line">curl -X PUT -d <span class="string">"<span class="variable">$MAXCONN</span>"</span> http://localhost:8500/v1/kv/service/haproxy/maxconn</div><div class="line"></div><div class="line">To verify that the value was <span class="built_in">set</span>, I used:</div><div class="line"></div><div class="line">$ cat query_consul_kv.sh</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">curl -v http://localhost:8500/v1/kv/?recurse</div><div class="line"></div><div class="line">$ ./query_consul_kv.sh</div><div class="line">* About to connect() to localhost port 8500 (<span class="comment">#0)</span></div><div class="line">*   Trying 127.0.0.1... connected</div><div class="line">&gt; GET /v1/kv/?recurse HTTP/1.1</div><div class="line">&gt; User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3</div><div class="line">&gt; Host: localhost:8500</div><div class="line">&gt; Accept: */*</div><div class="line">&gt;</div><div class="line">&lt; HTTP/1.1 200 OK</div><div class="line">&lt; Content-Type: application/json</div><div class="line">&lt; X-Consul-Index: 30563</div><div class="line">&lt; X-Consul-Knownleader: <span class="literal">true</span></div><div class="line">&lt; X-Consul-Lastcontact: 0</div><div class="line">&lt; Date: Mon, 17 Nov 2014 23:01:07 GMT</div><div class="line">&lt; Content-Length: 118</div><div class="line">&lt;</div><div class="line">* Connection <span class="comment">#0 to host localhost left intact</span></div><div class="line">* Closing connection <span class="comment">#0</span></div><div class="line">[&#123;<span class="string">"CreateIndex"</span>:10995,<span class="string">"ModifyIndex"</span>:30563,<span class="string">"LockIndex"</span>:0,<span class="string">"Key"</span>:<span class="string">"service/haproxy/maxconn"</span>,<span class="string">"Flags"</span>:0,<span class="string">"Value"</span>:<span class="string">"NDAwMA=="</span>&#125;]</div></pre></td></tr></table></figure></p>
<p>At this point, everything is ready for starting up the consul-template service (in Ubuntu), I did it via this Upstart configuration file:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/init/consul-template.conf</span></div><div class="line"><span class="comment"># Consul Template (Upstart unit)</span></div><div class="line">description <span class="string">"Consul Template"</span></div><div class="line">start on (<span class="built_in">local</span>-filesystems and net-device-up IFACE!=lo)</div><div class="line">stop on runlevel [06]</div><div class="line"></div><div class="line"><span class="built_in">exec</span> /opt/consul-template/bin/consul-template  -config=/opt/consul-template/config/consul-template.cfg &gt;&gt; /var/<span class="built_in">log</span>/consul-template 2&gt;&amp;1</div><div class="line"></div><div class="line">respawn</div><div class="line">respawn <span class="built_in">limit</span> 10 10</div><div class="line"><span class="built_in">kill</span> timeout 10</div><div class="line"></div><div class="line"><span class="comment"># start consul-template</span></div></pre></td></tr></table></figure></p>
<p>Once consul-template starts, it will peform the actions corresponding to the functions defined in the template file /opt/consul-template/templates/haproxy.ctmpl. In my case, it will query Consul for the value of the key service/haproxy/maxconn and for information about the 2 Consul services varnish.service and ssl.service. It will then save the generated file to /etc/haproxy/haproxy.cfg and it will restart the haproxy service. The relevant snippets from haproxy.cfg are:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">frontend http</div><div class="line">  maxconn 4000</div><div class="line">  <span class="built_in">bind</span> 0.0.0.0:80</div><div class="line">  default_backend servers-http</div><div class="line"></div><div class="line">backend servers-http</div><div class="line">  balance            roundrobin</div><div class="line">  option httpchk GET /</div><div class="line">  option  httplog</div><div class="line"></div><div class="line">    server wordpress1 10.0.1.1:6081 weight 1 check port 6081</div><div class="line"></div><div class="line"></div><div class="line">    server wordpress2 10.0.1.2:6081 backup weight 1 check port 6081</div><div class="line"></div><div class="line">and</div><div class="line"></div><div class="line">frontend https</div><div class="line">  maxconn            4000</div><div class="line">  mode               tcp</div><div class="line">  <span class="built_in">bind</span>               0.0.0.0:443</div><div class="line">  default_backend    servers-https</div><div class="line"></div><div class="line">backend servers-https</div><div class="line">  mode               tcp</div><div class="line">  option             tcplog</div><div class="line">  balance            roundrobin</div><div class="line"></div><div class="line">    server wordpress1 10.0.1.1:443 weight 1 check port 443</div><div class="line"></div><div class="line"></div><div class="line">    server wordpress2 10.0.1.2:443 backup weight 1 check port 443</div></pre></td></tr></table></figure></p>
<p>I’ve been running this as a test on lb2. I don’t consider my setup quite production-ready because I don’t have monitoring in place, and I also want to experiment with consul security tokens for better security. But this is a pattern that I think will work.</p>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/2016/02/27/how-many-shards-index/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Más nuevo</strong>
            <div class="article-nav-title">
                
                    Optimizing Elasticsearch-How Many Shards per Index
                
            </div>
        </a>
    
    
        <a href="/2016/02/04/presto-parquet-airpal/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Más viejo</strong>
            <div class="article-nav-title">Presto, Parquet &amp; Airpal</div>
        </a>
    
</nav>





    
    
        <section id="comments"> 
    <div class="ds-thread" data-thread-key="2016/02/19/service-discovery-consul-and-consul-template/" data-title="Service discovery with consul and consul-template" data-url="https://blog.djstudy.net/2016/02/19/service-discovery-consul-and-consul-template/"></div>
    <style>
        #ds-thread #ds-reset .ds-textarea-wrapper {
            background: none;
        }
        #ds-reset .ds-avatar img {
            box-shadow: none;
        }
        #ds-reset .ds-gradient-bg {
            background: #f7f7f7;
        }
        #ds-thread #ds-reset li.ds-tab a {
            border-radius: 3px;
        }
        #ds-thread #ds-reset .ds-post-button {
            color: white;
            border: none;
            box-shadow: none;
            background: #d32;
            text-shadow: none;
            font-weight: normal;
            font-family: 'Microsoft Yahei';
        }
        #ds-thread #ds-reset .ds-post-button:hover {
            color: white;
            background: #DE594C;
        }
        #ds-thread #ds-reset .ds-post-button:active {
            background: #d32;
        }
        #ds-smilies-tooltip ul.ds-smilies-tabs li a.ds-current {
            color: white;
            background: #d32;
            box-shadow: none;
            text-shadow: none;
            font-weight: normal;
        }
    </style>
 </section>
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>     
</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            东杰 &copy; 2018 
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>

        
    
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'hivefans'};
    (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
    || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>



    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>